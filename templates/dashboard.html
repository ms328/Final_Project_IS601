{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<!-- ===================== Alerts ===================== -->
<div id="errorAlert"
     class="hidden bg-red-100 border border-red-500 text-red-800 px-4 py-3 rounded-md mb-4">
  <span id="errorMessage"></span>
</div>

<div id="successAlert"
     class="hidden bg-green-100 border border-green-500 text-green-800 px-4 py-3 rounded-md mb-4">
  <span id="successMessage"></span>
</div>

<!-- ===================== Stats Card (NEW FEATURE) ===================== -->
<div class="bg-white shadow rounded-lg p-6 mb-6 border">
  <h2 class="text-lg font-bold mb-4 text-gray-800">ðŸ“Š Your Calculation Stats</h2>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-gray-700">
    <div>
      <span class="font-semibold">Total Calculations:</span>
      <span id="statTotal">â€“</span>
    </div>
    <div>
      <span class="font-semibold">Additions:</span>
      <span id="statAddition">â€“</span>
    </div>
    <div>
      <span class="font-semibold">Multiplications:</span>
      <span id="statMultiplication">â€“</span>
    </div>
    <div>
      <span class="font-semibold">Last Calculation:</span>
      <span id="statLast">â€“</span>
    </div>
  </div>
</div>

<!-- ===================== New Calculation ===================== -->
<div class="bg-white shadow rounded-lg p-6 mb-6 border">
  <h2 class="text-xl font-bold mb-4">New Calculation</h2>

  <form id="calculationForm" class="space-y-4">
    <div>
      <label class="block text-sm font-medium">Operation</label>
      <select id="calcType" class="w-full border rounded p-2">
        <option value="addition">Addition</option>
        <option value="subtraction">Subtraction</option>
        <option value="multiplication">Multiplication</option>
        <option value="division">Division</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium">Numbers (comma separated)</label>
      <input id="calcInputs" type="text"
             placeholder="e.g. 5, 10, 15"
             class="w-full border rounded p-2" />
    </div>

    <button type="submit"
            class="bg-blue-700 text-white px-5 py-2 rounded hover:bg-blue-800">
      Calculate
    </button>
  </form>
</div>

<!-- ===================== History Table ===================== -->
<div class="bg-white shadow rounded-lg p-6 border">
  <h2 class="text-xl font-bold mb-4">Calculation History</h2>

  <table class="w-full table-auto border">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 border">Type</th>
        <th class="p-2 border">Inputs</th>
        <th class="p-2 border">Result</th>
        <th class="p-2 border">Date</th>
        <th class="p-2 border">Actions</th>
      </tr>
    </thead>
    <tbody id="calculationsTable">
      <tr>
        <td colspan="5" class="p-4 text-center text-gray-500">
          Loading calculations...
        </td>
      </tr>
    </tbody>
  </table>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("access_token");
  if (!token) {
    window.location.href = "/login";
    return;
  }

  function showError(msg) {
    document.getElementById("errorMessage").textContent = msg;
    document.getElementById("errorAlert").classList.remove("hidden");
  }

  function showSuccess(msg) {
    document.getElementById("successMessage").textContent = msg;
    document.getElementById("successAlert").classList.remove("hidden");
    setTimeout(() => {
      document.getElementById("successAlert").classList.add("hidden");
    }, 3000);
  }

  // ===================== Load Stats =====================
  async function loadStats() {
    const res = await fetch("/calculations/stats", {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!res.ok) return;

    const stats = await res.json();

    document.getElementById("statTotal").textContent =
      stats.total_calculations;

    document.getElementById("statAddition").textContent =
      stats.by_type.addition || 0;

    document.getElementById("statMultiplication").textContent =
      stats.by_type.multiplication || 0;

    document.getElementById("statLast").textContent =
      stats.last_calculation
        ? new Date(stats.last_calculation).toLocaleString()
        : "N/A";
  }

  // ===================== Load History =====================
  async function loadCalculations() {
    const res = await fetch("/calculations", {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!res.ok) {
      showError("Failed to load calculations");
      return;
    }

    const data = await res.json();
    const tbody = document.getElementById("calculationsTable");
    tbody.innerHTML = "";

    if (data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="p-4 text-center text-gray-500">
            No calculations yet
          </td>
        </tr>`;
      return;
    }

    data.forEach(calc => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="border p-2 capitalize">${calc.type}</td>
        <td class="border p-2">${calc.inputs.join(", ")}</td>
        <td class="border p-2 font-semibold">${calc.result}</td>
        <td class="border p-2">${new Date(calc.created_at).toLocaleString()}</td>
        <td class="border p-2">
          <button class="text-red-600 delete-btn" data-id="${calc.id}">
            Delete
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });

    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (!confirm("Delete this calculation?")) return;

        await fetch(`/calculations/${btn.dataset.id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` }
        });

        showSuccess("Calculation deleted");
        loadCalculations();
        loadStats();
      });
    });
  }

  // ===================== Create Calculation =====================
  document.getElementById("calculationForm").addEventListener("submit", async e => {
    e.preventDefault();

    const inputs = document.getElementById("calcInputs").value
      .split(",")
      .map(n => parseFloat(n.trim()))
      .filter(n => !isNaN(n));

    if (inputs.length < 2) {
      showError("Enter at least two numbers");
      return;
    }

    const payload = {
      type: document.getElementById("calcType").value,
      inputs
    };

    const res = await fetch("/calculations", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      showError("Failed to create calculation");
      return;
    }

    showSuccess("Calculation created");
    e.target.reset();
    loadCalculations();
    loadStats();
  });
yes